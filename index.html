<!DOCTYPE html>

<html>

<head>
    <title>Title</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

    <script type="text/javascript" src="/js/login.js"></script>

    <script type="text/javascript" src="/js/three.min.js"></script>
    <script type="text/javascript" src="/js/stats.js"></script>
    <script type="text/javascript" src="/js/physi.js"></script>

    <script type="text/javascript">
    'use strict';

    function Game() {

    }

    Game.prototype.init = function() {
            Physijs.scripts.worker = '/js/physijs_worker.js';
            Physijs.scripts.ammo = '/js/ammo.js';

            // Init renderer 
            this.renderer = new THREE.WebGLRenderer({ antialias: true });
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.renderer.shadowMap.enabled = true;
            this.renderer.shadowMapSoft = true;
            document.getElementById('viewport').appendChild(this.renderer.domElement);

            // Init Stats
            this.render_stats = new Stats();
            this.render_stats.domElement.style.position = 'absolute';
            this.render_stats.domElement.style.top = '0px;';
            this.render_stats.domElement.style.zIndex = 100;
            document.getElementById('viewport').appendChild(this.render_stats.domElement);
            this.physics_stats = new Stats();
            this.physics_stats.domElement.style.position = 'absolute';
            this.physics_stats.domElement.style.top = '50px;';
            this.physics_stats.domElement.style.zIndex = 100;
            document.getElementById('viewport').appendChild(this.physics_stats.domElement);

            // Init physics
            this.scene = new Physijs.Scene;
            this.scene.setGravity(new THREE.Vector3( 0, -30, 0 ));
            this.scene.addEventListener(
                'update',
                this.onPhysicsUpdate.bind(this)
            );

            // Init camera
            this.camera = new THREE.PerspectiveCamera(
                35,
                window.innerWidth / window.innerHeight,
                1,
                1000
            );
            this.camera.position.set( 60, 50, 60 );
            this.camera.lookAt( this.scene.position );
            this.camera_angle = 0;
            this.scene.add( this.camera );

            // Init texture Loader
            this.texture_loader = new THREE.TextureLoader();
            this.texture_loader.crossOrigin = 'anonymous';

            // Init light
            this.light = new THREE.DirectionalLight( 0xFFFFFF );
            this.light.position.set( 20, 40, -15);
            this.light.target.position.copy( this.scene.position );
            this.light.castShadow = true;
            this.light.shadowCameraLeft = -60;
            this.light.shadowCameraTop = -60;
            this.light.shadowCameraRight = 60;
            this.light.shadowCameraBottom = 60;
            this.light.shadowCameraNear = 20;
            this.light.shadowCameraFar = 200;
            this.light.shadowBias = -.0001
            this.light.shadowMapWidth = this.light.shadowMapHeight = 2048;
            this.light.shadowDarkness = .7;
            this.scene.add( this.light );


            //Ambient light
            this.ambientLight = new THREE.AmbientLight( 0x404040 ); // soft white light
            this.ambientLight.position.set( -40, 20, -15);
            this.scene.add(this.ambientLight );

            // Initial objects
            console.log(this);
            this.initGround();
            this.initKatamari();
            this.music = new Audio('/media/songs/katamari_jazz.mp3');
            this.music.play();

            // Init events
            this.initEvents();

            // Begin rendering
            var self = this;
            setTimeout(function() {
                requestAnimationFrame(self.render.bind(self));
                self.scene.simulate(); 
            }, 100);
                       
    };

    Game.prototype.initGround = function() {
            this.worldWidth = 200;
            this.worldLength = 200;
            var ground_material = Physijs.createMaterial(
                new THREE.MeshLambertMaterial({map: this.texture_loader.load('/media/texture/grass_dark.jpg')}),
                .8, //high friction
                .3 //low resolution
            );
            //TODO: why does the wall texture not show up properly
            ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
            ground_material.map.repeat.set( 3, 3 );
            var wall_material = Physijs.createMaterial(
                new THREE.MeshLambertMaterial({map: this.texture_loader.load('/media/texture/wood_dark.jpg')}),
                .2, //low friction
                .3 //low resolution
            );
            wall_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
            wall_material.map.repeat.set( 3, 3 );
            this.walls = new Array(4)
            this.initWall(this.worldWidth, 1, 0, this.worldLength / 2, 1, wall_material);
            this.initWall(this.worldWidth, 1, 0, -1 * this.worldLength / 2, 2, wall_material);
            this.initWall(1, this.worldLength, this.worldWidth / 2, 0, 3, wall_material);
            this.initWall(1, this.worldLength, -1 * this.worldWidth / 2, 0, 4, wall_material);
            this.ground = new Physijs.BoxMesh(
                new THREE.BoxGeometry(this.worldWidth,1,this.worldLength),
                ground_material,
                0 //mass, makes object immovable
            );
            this.ground.recieveShadow = true;
            this.scene.add( this.ground );
            this.ground.type = 'GROUND'; 
    };

    Game.prototype.initWall = function(xWidth, zWidth, xOff, zOff, i, wall_material) {
            this.walls[i] = new Physijs.BoxMesh(
                new THREE.BoxGeometry(xWidth,40,zWidth),
                wall_material,
                0 //makes wall immovable
            );
            this.walls[i].position.set(
                xOff,
                0,
                zOff
            );
            this.scene.add( this.walls[i] );
    }

    Game.prototype.initKatamari = function() {
        var geometry = new THREE.SphereGeometry( 5, 8, 8 );
        var self = this;
        this.propic_size = 300;
        getProPic(this.user_id, this.propic_size, function(url) {
                var katamari_material  = Physijs.createMaterial(
                    new THREE.MeshLambertMaterial({map: self.texture_loader.load(url)}),
                    .8, //high friction
                    .3 //low resolution
                );
                self.katamari = new Physijs.SphereMesh( geometry, katamari_material );
                self.katamari.position.set(
                    0, // y
                    20, // z
                    0 // x
                );
                self.scene.add( self.katamari );

                self.katamari.addEventListener('collision',
                    self.onKatamariCollide.bind(self));
            },
            function(error) {
              console.log(error);
            }
        );         
    };

    Game.prototype.onKatamariCollide = function(other, rel_vel, rel_rot, con_norm) {
        var delta = other.position.sub(this.katamari.position);
        console.log(delta);

        /*
            var delta = other.position.sub(self.katamari.position);
            
                self.scene.remove(other);
                other.position.set(0, 10, 0);
                var lin_vel = self.katamari.getLinearVelocity();
                var ang_vel = self.katamari.getAngularVelocity();
                self.scene.remove(self.katamari);
                self.katamari.add(other);
                self.scene.add(self.katamari);
                self.katamari.setLinearVelocity(lin_vel);
                self.katamari.setAngularVelocity(ang_vel); */
    };

    Game.prototype.spawnItem = function(texture) {
        var geometry = new THREE.BoxGeometry(10, .2, 10);
        var material = Physijs.createMaterial(
            new THREE.MeshLambertMaterial({map: texture},
            .8, // high friction
            1  // low res
            )
        );
        var item = new Physijs.BoxMesh(geometry, material);
        item.position.set(15, 5, 15);
        item.type = 'ITEM';
        this.scene.add(item);
    };

    Game.prototype.initEvents = function() {
            document.addEventListener('keydown', this.onKeyDown.bind(this));
            document.addEventListener('keyup', this.onKeyUp.bind(this));
            this.leftPress = false;
            this.upPress = false;
            this.rightPress = false;
            this.downPress = false;
    };

        Game.prototype.onPhysicsUpdate = function() {
            this.scene.simulate(undefined, 1);
            if (this.upPress) {
                var xDir = -100000 * Math.sin(this.camera_angle);
                var zDir = -100000 * Math.cos(this.camera_angle);
                this.katamari.applyCentralForce(new THREE.Vector3(xDir, 0, zDir));
            } else if (this.downPress) {
                var xDir = 100000 * Math.sin(this.camera_angle);
                var zDir = 100000 * Math.cos(this.camera_angle);
                this.katamari.applyCentralForce(new THREE.Vector3(xDir, 0, zDir));
            }

            if (this.leftPress) {
                this.camera_angle = (this.camera_angle - (Math.PI / 36 / 2));
            } else if (this.rightPress) {
                this.camera_angle = (this.camera_angle + (Math.PI / 36 / 2));
            }

            this.physics_stats.update();
        };

        Game.prototype.render = function() {
            requestAnimationFrame(this.render.bind(this));
            this.camera.lookAt(this.katamari.position);
            var cameraX = 100 * Math.sin(this.camera_angle) + this.katamari.position.x;
            var cameraZ = 100 * Math.cos(this.camera_angle) + this.katamari.position.z;
            this.renderer.render(this.scene, this.camera);
            this.camera.position.set(cameraX, 50, cameraZ);
            this.render_stats.update();
        };

        Game.prototype.onKeyDown = function(event) {
            switch(event.keyCode) {
                case 65: case 37:
                    //left arrow
                    this.leftPress = true;
                    break;
                case 68: case 39:
                    //right arrow
                    this.rightPress = true;
                    break;
                case 87: case 38:
                    //up arrow
                    this.upPress = true;
                    break;
                case 83: case 40:
                    //down arrow
                    this.downPress = true;
                    break;

                case 13:
                    // enter
                    this.spawnItem(this.texture_loader.load('https://scontent.xx.fbcdn.net/hprofile-xaf1/v/t1.0-1/p130x130/11425243_843291312375492_917744822880444359_n.jpg?oh=a9282471497f5dd87403f13764366e6c&oe=5726A29A'));
                    break;
            }
        };


        Game.prototype.onKeyUp = function(event) {
            switch(event.keyCode) {
                case 65: case 37:
                    //left arrow
                    this.leftPress = false;
                    break;
                case 68: case 39:
                    //right arrow
                    this.rightPress = false;
                    break;
                case 87: case 38:
                    //up arrow
                    this.upPress = false;
                    break;
                case 83: case 40:
                    //down arrow
                    this.downPress = false;
                    break;   
            }
        }

    $(document).ready(function() {
        initLoginStatus(function(){
            successLogin()
        }, function(){
            failLogin()
        });
    });

    function successLogin(){
        getUserId(function(user_id){
            $("#login").hide();
            var game = new Game();
            game.user_id = user_id;
            game.init();
        });
    }

    function failLogin(){
        $("#login").show();
    }

    </script>
</head>

<body>
    <div id="login" hidden>
        <fb:login-button scope="public_profile,email" onlogin="checkLoginState(function(){successLogin()}, function(){failLogin()});">
        </fb:login-button>
    </div>
    <div id="heading">
        <h1>Title</h1>
        <p>Does stuff</p>
    </div>

    <div id="viewport"></div>
</body>

</html>
