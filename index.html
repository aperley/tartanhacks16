<!DOCTYPE html>

<html>

<head>
    <title>Title</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

    <script type="text/javascript" src="/js/login.js"></script>

    <script type="text/javascript" src="/js/three.min.js"></script>
    <script type="text/javascript" src="/js/stats.js"></script>
    <script type="text/javascript" src="/js/physi.js"></script>

    <script type="text/javascript">
    'use strict';

    function Game() {

    }

    Game.prototype.init = function() {
            Physijs.scripts.worker = '/js/physijs_worker.js';
            Physijs.scripts.ammo = '/js/ammo.js';

            // Init renderer 
            this.renderer = new THREE.WebGLRenderer({ antialias: true });
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.renderer.shadowMap.enabled = true;
            this.renderer.shadowMapSoft = true;
            document.getElementById('viewport').appendChild(this.renderer.domElement);

            // Init Stats
            this.render_stats = new Stats();
            this.render_stats.domElement.style.position = 'absolute';
            this.render_stats.domElement.style.top = '0px;';
            this.render_stats.domElement.style.zIndex = 100;
            document.getElementById('viewport').appendChild(this.render_stats.domElement);
            this.physics_stats = new Stats();
            this.physics_stats.domElement.style.position = 'absolute';
            this.physics_stats.domElement.style.top = '50px;';
            this.physics_stats.domElement.style.zIndex = 100;
            document.getElementById('viewport').appendChild(this.physics_stats.domElement);

            // Init physics
            this.scene = new Physijs.Scene;
            this.scene.setGravity(new THREE.Vector3( 0, -30, 0 ));
            this.scene.addEventListener(
                'update',
                this.onPhysicsUpdate.bind(this)
            );

            // Init camera
            this.camera = new THREE.PerspectiveCamera(
                35,
                window.innerWidth / window.innerHeight,
                1,
                1000
            );
            this.camera.position.set( 60, 50, 60 );
            this.camera.lookAt( this.scene.position );
            this.camera_angle = 0;
            this.scene.add( this.camera );

            // Init texture Loader
            this.texture_loader = new THREE.TextureLoader();
            this.texture_loader.crossOrigin = 'anonymous';

            // Init light
            this.light = new THREE.DirectionalLight( 0xFFFFFF );
            this.light.position.set( 20, 40, -15 );
            this.light.target.position.copy( this.scene.position );
            this.light.castShadow = true;
            this.light.shadowCameraLeft = -60;
            this.light.shadowCameraTop = -60;
            this.light.shadowCameraRight = 60;
            this.light.shadowCameraBottom = 60;
            this.light.shadowCameraNear = 20;
            this.light.shadowCameraFar = 200;
            this.light.shadowBias = -.0001
            this.light.shadowMapWidth = this.light.shadowMapHeight = 2048;
            this.light.shadowDarkness = .7;
            this.scene.add( this.light );

            // Initial objects
            console.log(this);
            this.initGround();
            this.initKatamari();
            new Audio('/media/songs/katamari_jazz.mp3').play()

            // Init events
            this.initEvents();

            // Begin rendering
            requestAnimationFrame(this.render.bind(this));
            this.scene.simulate();            
    };

    Game.prototype.initGround = function() {
            var ground_material = Physijs.createMaterial(
                new THREE.MeshLambertMaterial({map: this.texture_loader.load('/media/texture/grass_dark.jpg')}),
                .8, //high friction
                .3 //low resolution
            );
            ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
            ground_material.map.repeat.set( 3, 3 );

            this.ground = new Physijs.BoxMesh(
                new THREE.BoxGeometry(100,1,100),
                ground_material,
                0 //mass, makes object immovable
            );
            this.ground.recieveShadow = true;
            this.scene.add( this.ground ); 
    };

    Game.prototype.initKatamari = function() {
            var geometry = new THREE.SphereGeometry( 5, 8, 8 );
            var self = this;
            console.log(this.user_id);
            getProPic(this.user_id, function(url) {
                    var katamari_material  = Physijs.createMaterial(
                        new THREE.MeshLambertMaterial({map: self.texture_loader.load(url)}),
                        .8, //high friction
                        .3 //low resolution
                    );
                    self.katamari = new Physijs.SphereMesh( geometry, katamari_material );
                    self.katamari.position.set(
                        0, // y
                        20, // z
                        0 // x
                    );
                    self.scene.add( self.katamari );
                },
                function(error) {
                  console.log(error);
                });          
    };

    Game.prototype.initEvents = function() {
            document.addEventListener('keydown', this.onKeyDown.bind(this));
            document.addEventListener('keyup', this.onKeyUp.bind(this));
            this.leftPress = false;
            this.upPress = false;
            this.rightPress = false;
            this.downPress = false;
    };

        Game.prototype.onPhysicsUpdate = function() {
            this.scene.simulate(undefined, 1);
            if (this.upPress) {
                var xDir = -10000 * Math.sin(this.camera_angle);
                var zDir = -10000 * Math.cos(this.camera_angle);
                this.katamari.applyCentralForce(new THREE.Vector3(xDir, 0, zDir));
            } else if (this.downPress) {
                var xDir = 10000 * Math.sin(this.camera_angle);
                var zDir = 10000 * Math.cos(this.camera_angle);
                this.katamari.applyCentralForce(new THREE.Vector3(xDir, 0, zDir));
            }

            if (this.leftPress) {
                this.camera_angle = (this.camera_angle + (Math.PI / 36));
            } else if (this.rightPress) {
                this.camera_angle = (this.camera_angle - (Math.PI / 36));
            }

            this.physics_stats.update();
        };

        Game.prototype.render = function() {
            requestAnimationFrame(this.render.bind(this));
            this.camera.lookAt(this.katamari.position);
            var cameraX = 100 * Math.sin(this.camera_angle) + this.katamari.position.x;
            var cameraZ = 100 * Math.cos(this.camera_angle) + this.katamari.position.z;
            this.renderer.render(this.scene, this.camera);
            this.camera.position.set(cameraX, 50, cameraZ);
            this.render_stats.update();
        };

        Game.prototype.onKeyDown = function(event) {
            switch(event.keyCode) {
                case 65: case 37:
                    //left arrow
                    this.leftPress = true;
                    break;
                case 68: case 39:
                    //right arrow
                    this.rightPress = true;
                    break;
                case 87: case 38:
                    //up arrow
                    this.upPress = true;
                    break;
                case 83: case 40:
                    //down arrow
                    this.downPress = true;
                    break;
            }
        };


        Game.prototype.onKeyUp = function(event) {
            switch(event.keyCode) {
                case 65: case 37:
                    //left arrow
                    this.leftPress = false;
                    break;
                case 68: case 39:
                    //right arrow
                    this.rightPress = false;
                    break;
                case 87: case 38:
                    //up arrow
                    this.upPress = false;
                    break;
                case 83: case 40:
                    //down arrow
                    this.downPress = false;
                    break;   
            }
        }

    $(document).ready(function() {
        initLoginStatus(function(){
            successLogin()
        }, function(){
            failLogin()
        });
    });

    function successLogin(){
        getUserId(function(user_id){
            $("#login").hide();
            var game = new Game();
            game.user_id = user_id;
            game.init();
        });
    }

    function failLogin(){
        $("#login").show();
    }

    </script>
</head>

<body>
    <div id="login" hidden>
        <fb:login-button scope="public_profile,email" onlogin="checkLoginState(function(){successLogin()}, function(){failLogin()});">
        </fb:login-button>
    </div>
    <div id="heading">
        <h1>Title</h1>
        <p>Does stuff</p>
    </div>

    <div id="viewport"></div>
</body>

</html>
